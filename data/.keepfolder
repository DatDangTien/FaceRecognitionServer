import cv2
from facenet_pytorch import MTCNN, InceptionResnetV1
import torch
import numpy as np
import os

device = torch.device('cuda:0' if torch.cuda.is_available() else 'cpu')
print("Using device:", device)

DATA_PATH = './data'
os.makedirs(DATA_PATH, exist_ok=True)

def load_existing_data():
    """Load existing embeddings and usernames"""
    embeddings = None
    usernames = None
    
    # Load embeddings
    if device.type == 'cpu':
        embedding_file = os.path.join(DATA_PATH, "faceslistCPU.pth")
    else:
        embedding_file = os.path.join(DATA_PATH, "faceslist.pth")
    
    if os.path.exists(embedding_file):
        embeddings = torch.load(embedding_file)
        print(f"Loaded embeddings: {embeddings.shape}")
    
    # Load usernames
    username_file = os.path.join(DATA_PATH, "usernames.npy")
    if os.path.exists(username_file):
        usernames = np.load(username_file)
        print(f"Loaded usernames: {usernames}")
    
    return embeddings, usernames

def save_data(embeddings, usernames):
    """Save embeddings and usernames to files"""
    # Save embeddings
    if device.type == 'cpu':
        torch.save(embeddings, os.path.join(DATA_PATH, "faceslistCPU.pth"))
    else:
        torch.save(embeddings, os.path.join(DATA_PATH, "faceslist.pth"))
    
    # Save usernames
    np.save(os.path.join(DATA_PATH, "usernames.npy"), usernames)
    print(f"âœ… Data saved successfully!")

def show_user_list(usernames):
    """Display list of registered users"""
    if usernames is None or len(usernames) == 0:
        print("ğŸ“‹ Danh sÃ¡ch user trá»‘ng")
        return
    
    print("\nğŸ“‹ DANH SÃCH USER ÄÃƒ ÄÄ‚NG KÃ:")
    print("-" * 40)
    for i, username in enumerate(usernames, 1):
        print(f"{i}. {username}")
    print("-" * 40)
    print(f"Tá»•ng cá»™ng: {len(usernames)} user(s)")

def delete_user(embeddings, usernames):
    """Delete a specific user"""
    if usernames is None or len(usernames) == 0:
        print("âŒ KhÃ´ng cÃ³ user nÃ o Ä‘á»ƒ xÃ³a")
        return embeddings, usernames
    
    show_user_list(usernames)
    
    while True:
        try:
            choice = input(f"\nChá»n user cáº§n xÃ³a (1-{len(usernames)}) hoáº·c 'q' Ä‘á»ƒ há»§y: ").strip()
            if choice.lower() == 'q':
                print("âŒ Há»§y xÃ³a user")
                return embeddings, usernames
            
            user_index = int(choice) - 1
            if 0 <= user_index < len(usernames):
                user_to_delete = usernames[user_index]
                confirm = input(f"Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a user '{user_to_delete}'? (y/n): ").lower().strip()
                
                if confirm in ['y', 'yes', 'cÃ³']:
                    # Remove user from usernames
                    new_usernames = np.delete(usernames, user_index)
                    
                    # Remove corresponding embedding
                    if embeddings is not None:
                        new_embeddings = torch.cat([embeddings[:user_index], embeddings[user_index+1:]])
                    else:
                        new_embeddings = None
                    
                    # Save updated data
                    save_data(new_embeddings, new_usernames)
                    print(f"âœ… ÄÃ£ xÃ³a user '{user_to_delete}' thÃ nh cÃ´ng!")
                    return new_embeddings, new_usernames
                else:
                    print("âŒ Há»§y xÃ³a user")
                    return embeddings, usernames
            else:
                print(f"âŒ Vui lÃ²ng chá»n sá»‘ tá»« 1 Ä‘áº¿n {len(usernames)}")
        except ValueError:
            print("âŒ Vui lÃ²ng nháº­p sá»‘ há»£p lá»‡")

def register_new_user():
    """Register a new user"""
    usr_name = input("Input your name: ")
    if not usr_name.strip():
        print("âŒ TÃªn khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng")
        return
    
    count = 50
    embeddings = []
    
    mtcnn = MTCNN(
        margin=20,
        keep_all=False,
        select_largest=True,
        post_process=True,
        device=device
    )
    
    model_embedding = InceptionResnetV1(
        classify=False,
        pretrained="casia-webface"
    ).to(device)
    model_embedding.eval()
    
    cap = cv2.VideoCapture(0)
    cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
    cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
    
    # Khá»Ÿi táº¡o tracker
    trackers = []
    tracker_initialized = False
    detection_interval = 3
    frame_count = 0
    
    leap = 1
    print(f"ğŸ¥ Báº¯t Ä‘áº§u capture face cho user '{usr_name}'...")
    print("Nháº¥n ESC Ä‘á»ƒ thoÃ¡t")
    
    while cap.isOpened() and count > 0:
        ret, frame = cap.read()
        if not ret:
            break
        
        frame_count += 1
        
        # Detect faces má»›i hoáº·c khi chÆ°a cÃ³ tracker
        if not tracker_initialized or frame_count % detection_interval == 0:
            boxes, _, points_list = mtcnn.detect(frame, landmarks=True)
            if boxes is not None:
                # Táº¡o trackers má»›i
                trackers = []
                for box in boxes:
                    tracker = cv2.legacy.TrackerCSRT_create()
                    bbox = (int(box[0]), int(box[1]), int(box[2]-box[0]), int(box[3]-box[1]))
                    tracker.init(frame, bbox)
                    trackers.append(tracker)
                tracker_initialized = True
        
        # Update trackers vÃ  váº½ bounding boxes
        if tracker_initialized and trackers:
            for i, tracker in enumerate(trackers):
                success, bbox = tracker.update(frame)
                if success:
                    # Váº½ bbox tá»« tracker
                    x, y, w, h = [int(v) for v in bbox]
                    frame = cv2.rectangle(frame, (x, y), (x + w, y + h), (0, 0, 255), 6)
                    
                    # Láº¥y face tá»« bbox Ä‘á»ƒ extract embedding
                    if leap % 3 == 0:
                        face_roi = frame[y:y+h, x:x+w]
                        if face_roi.size > 0:
                            face_rgb = cv2.cvtColor(face_roi, cv2.COLOR_BGR2RGB)
                            face_tensor = mtcnn(face_rgb)
                            if face_tensor is not None:
                                with torch.no_grad():
                                    embedding = model_embedding(face_tensor.unsqueeze(0).to(device))
                                    embeddings.append(embedding)
                                count -= 1
                                print(f"Captured embedding {50-count}/50")
        
        # Hiá»ƒn thá»‹ progress
        cv2.putText(frame, f"Progress: {50-count}/50", (10, 30), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 0), 2)
        cv2.putText(frame, f"User: {usr_name}", (10, 70), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 0), 2)
        
        leap += 1
        
        cv2.imshow("Face Capturing", frame)
        if cv2.waitKey(1) & 0xFF == 27:
            break
    
    cap.release()
    cv2.destroyAllWindows()
    
    # Xá»­ lÃ½ káº¿t quáº£
    if len(embeddings) > 0:
        embedding = torch.cat(embeddings).mean(0, keepdim=True)
        names = np.array([usr_name])
        
        # Load existing data
        existing_embeddings, existing_usernames = load_existing_data()
        
        # Merge with existing data
        if existing_embeddings is not None:
            new_embeddings = torch.cat([existing_embeddings, embedding])
            new_usernames = np.concatenate([existing_usernames, names])
        else:
            new_embeddings = embedding
            new_usernames = names
        
        # Save data
        save_data(new_embeddings, new_usernames)
        print(f'âœ… ÄÄƒng kÃ½ user "{usr_name}" thÃ nh cÃ´ng!')
        
    else:
        print("âŒ KhÃ´ng cÃ³ embedding nÃ o Ä‘Æ°á»£c capture. ÄÄƒng kÃ½ tháº¥t báº¡i.")

def main_menu():
    """Main menu system"""
    while True:
        print("\n" + "="*50)
        print("ğŸ­ FACE RECOGNITION SYSTEM")
        print("="*50)
        print("1. ğŸ“ ÄÄƒng kÃ½ user má»›i")
        print("2. ğŸ“‹ Xem danh sÃ¡ch user")
        print("3. ğŸ—‘ï¸  XÃ³a user")
        print("4. âŒ ThoÃ¡t")
        print("="*50)
        
        choice = input("Chá»n chá»©c nÄƒng (1-4): ").strip()
        
        if choice == '1':
            register_new_user()
        elif choice == '2':
            _, usernames = load_existing_data()
            show_user_list(usernames)
        elif choice == '3':
            embeddings, usernames = load_existing_data()
            delete_user(embeddings, usernames)
        elif choice == '4':
            print("ğŸ‘‹ Táº¡m biá»‡t!")
            break
        else:
            print("âŒ Vui lÃ²ng chá»n tá»« 1-4")

if __name__ == "__main__":
    main_menu()